{% extends "layout.html" %}

{% block title %}
    Task Manager
{% endblock %}

{% block style %}

 <style>
        /* Custom styles to enhance Bootstrap */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font */
            background-color: #f8f9fa; /* Light background */
        }
        .container {
            max-width: 900px;
            padding: 20px;
        }
        h1 {
            color: #343a40;
            font-weight: 600;
            margin-bottom: 30px;
            text-align: center;
        }
        .task-header {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* Space between elements in the header */
            margin-bottom: 0.5rem;
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
        }
        .task-header input[type="text"],
        .task-header input[type="date"] {
            flex-grow: 1; /* Allow inputs to take up available space */
            min-width: 150px; /* Ensure inputs don't get too small */
            border-radius: 0.5rem; /* Rounded corners for inputs */
        }
        .task-options {
            margin-bottom: 0.5rem;
        }
        .subtask-list {
            padding-left: 1.5rem; /* Indent subtasks */
            border-left: 2px solid #0d6efd; /* Visual cue for subtasks */
            margin-top: 1rem;
        }
        .card {
            border-radius: 0.75rem; /* More rounded cards */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Soft shadow */
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-3px); /* Subtle lift on hover */
        }
        .card-body {
            padding: 1.5rem;
        }
        .btn {
            border-radius: 0.5rem; /* Rounded buttons */
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
            transform: translateY(-1px);
        }
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
            transform: translateY(-1px);
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
            transform: translateY(-1px);
        }
        .form-floating > .form-control,
        .form-floating > .form-select {
            padding: 1rem 0.75rem; /* Adjust padding for better look with floating label */
        }
        .form-floating > label {
            padding-top: 0.75rem;
            padding-left: 0.75rem;
        }
    </style>

{% endblock %}

{% block main %}

    <div class="container mt-5">
        <h1 class="mb-4">My Dynamic Tasks</h1>
        <form id="task-manager-form" action="/save-tasks" method="POST">
            <div class="task-list">
                {% macro render_task_item(task, is_subtask=false) %}
                <div class="card {% if is_subtask %}card-body bg-light{% endif %} mb-3" data-task-id="{{ task.id }}">
                    <div class="card-body">
                        <div class="task-header">
                            <div class="form-floating flex-grow-1">
                                <input type="text" class="form-control" id="task_name_{{ task.id | replace('.', '_') }}" name="task_name_{{ task.id | replace('.', '_') }}" value="{{ task.name }}" placeholder="Task Name">
                                <label for="task_name_{{ task.id | replace('.', '_') }}">Task Name</label>
                            </div>
                            {% if task.due_date is defined %}
                            <div class="form-floating">
                                <input type="date" class="form-control" id="due_date_{{ task.id | replace('.', '_') }}" name="due_date_{{ task.id | replace('.', '_') }}" value="{{ task.due_date }}" placeholder="Due Date">
                                <label for="due_date_{{ task.id | replace('.', '_') }}">Due Date</label>
                            </div>
                            {% endif %}
                            <button type="button" class="btn {% if is_subtask %}btn-sm btn-outline-primary{% else %}btn-primary{% endif %} add-subtask-btn">Add Subtask</button>
                            <button type="button" class="btn {% if is_subtask %}btn-sm btn-outline-danger{% else %}btn-danger{% endif %} delete-task-btn">Delete</button>
                        </div>
                        <div class="task-options mb-3">
                            <div class="form-floating mb-2">
                                <textarea class="form-control" placeholder="Task Description" id="description_{{ task.id | replace('.', '_') }}" name="description_{{ task.id | replace('.', '_') }}" style="height: 100px;">{{ task.description }}</textarea>
                                <label for="description_{{ task.id | replace('.', '_') }}">Description</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="completed_{{ task.id | replace('.', '_') }}" name="completed_{{ task.id | replace('.', '_') }}" {% if task.completed %}checked{% endif %}>
                                <label class="form-check-label" for="completed_{{ task.id | replace('.', '_') }}">Completed</label>
                            </div>
                        </div>
                        {% if task.subtasks %}
                        <div class="subtask-list">
                            {% for subtask in task.subtasks %}
                                {{ render_task_item(subtask, true) }} {# Recursive call with is_subtask=true #}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endmacro %}

                {% for task in tasks %}
                    {{ render_task_item(task) }} {# Initial call for main tasks #}
                {% endfor %}
            </div>
            <button type="submit" class="btn btn-success mt-3">Save All Tasks</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Counter for generating unique IDs for new tasks/subtasks
            let taskIdCounter = 0;

            /**
             * Generates a new unique ID for a task or subtask.
             * If parentTaskId is provided, it creates a subtask ID (e.g., "1.1").
             * Otherwise, it creates a main task ID (e.g., "2").
             * @param {string|null} parentTaskId - The ID of the parent task, or null for a main task.
             * @returns {string} A unique task ID.
             */
            function generateNewTaskId(parentTaskId = null) {
                const newId = ++taskIdCounter;
                if (parentTaskId) {
                    return `${parentTaskId}.${newId}`;
                }
                return String(newId);
            }

            /**
             * Generates the HTML string for a new task or subtask.
             * @param {string} taskId - The unique ID for the new task/subtask.
             * @param {boolean} isSubtask - True if it's a subtask, false otherwise.
             * @returns {string} The HTML string for the task item.
             */
            function generateTaskHtml(taskId, isSubtask) {
                // Replace dots in ID for HTML element IDs
                const htmlId = taskId.replace(/\./g, '_');
                const cardClass = isSubtask ? 'card-body bg-light' : '';
                const btnClass = isSubtask ? 'btn-sm btn-outline-primary' : 'btn-primary';
                const deleteBtnClass = isSubtask ? 'btn-sm btn-outline-danger' : 'btn-danger';

                return `
                    <div class="card ${cardClass} mb-3" data-task-id="${taskId}">
                        <div class="card-body">
                            <div class="task-header">
                                <div class="form-floating flex-grow-1">
                                    <input type="text" class="form-control" id="task_name_${htmlId}" name="task_name_${htmlId}" value="" placeholder="Task Name">
                                    <label for="task_name_${htmlId}">Task Name</label>
                                </div>
                                <div class="form-floating">
                                    <input type="date" class="form-control" id="due_date_${htmlId}" name="due_date_${htmlId}" value="" placeholder="Due Date">
                                    <label for="due_date_${htmlId}">Due Date</label>
                                </div>
                                <button type="button" class="btn ${btnClass} add-subtask-btn">Add Subtask</button>
                                <button type="button" class="btn ${deleteBtnClass} delete-task-btn">Delete</button>
                            </div>
                            <div class="task-options mb-3">
                                <div class="form-floating mb-2">
                                    <textarea class="form-control" placeholder="Task Description" id="description_${htmlId}" name="description_${htmlId}" style="height: 100px;"></textarea>
                                    <label for="description_${htmlId}">Description</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="completed_${htmlId}" name="completed_${htmlId}">
                                    <label class="form-check-label" for="completed_${htmlId}">Completed</label>
                                </div>
                            </div>
                            <div class="subtask-list">
                                <!-- Subtasks will be appended here -->
                            </div>
                        </div>
                    </div>
                `;
            }

            /**
             * Attaches event listeners to 'Add Subtask' and 'Delete' buttons within a given container.
             * This function is called for initial page load and for newly added tasks/subtasks.
             * @param {HTMLElement} container - The DOM element to search for buttons within.
             */
            function attachEventListeners(container) {
                // Attach 'Add Subtask' event listeners
                container.querySelectorAll('.add-subtask-btn').forEach(button => {
                    button.removeEventListener('click', handleAddSubtask); // Prevent duplicate listeners
                    button.addEventListener('click', handleAddSubtask);
                });

                // Attach 'Delete Task' event listeners
                container.querySelectorAll('.delete-task-btn').forEach(button => {
                    button.removeEventListener('click', handleDeleteTask); // Prevent duplicate listeners
                    button.addEventListener('click', handleDeleteTask);
                });
            }

            /**
             * Event handler for 'Add Subtask' button clicks.
             * @param {Event} event - The click event object.
             */
            function handleAddSubtask(event) {
                const parentTaskCard = event.target.closest('.card');
                if (!parentTaskCard) {
                    console.error('Could not find parent task card.');
                    return;
                }

                const parentTaskId = parentTaskCard.dataset.taskId;
                const newSubtaskId = generateNewTaskId(parentTaskId);
                const newSubtaskHtml = generateTaskHtml(newSubtaskId, true);

                let subtaskList = parentTaskCard.querySelector('.subtask-list');
                if (!subtaskList) {
                    // If subtask-list doesn't exist, create it (this shouldn't happen with the current HTML,
                    // as it's always included, but good for robustness).
                    subtaskList = document.createElement('div');
                    subtaskList.classList.add('subtask-list');
                    parentTaskCard.querySelector('.card-body').appendChild(subtaskList);
                }

                // Insert the new subtask HTML
                subtaskList.insertAdjacentHTML('beforeend', newSubtaskHtml);

                // Get the newly added subtask card and attach its event listeners
                const newlyAddedSubtask = subtaskList.lastElementChild;
                attachEventListeners(newlyAddedSubtask);
            }

            /**
             * Event handler for 'Delete Task' button clicks.
             * @param {Event} event - The click event object.
             */
            function handleDeleteTask(event) {
                const taskCardToDelete = event.target.closest('.card');
                if (taskCardToDelete) {
                    taskCardToDelete.remove();
                } else {
                    console.error('Could not find task card to delete.');
                }
            }

            // Initial attachment of event listeners to all existing buttons on page load
            attachEventListeners(document);
        });
    </script>

{% endblock %}
